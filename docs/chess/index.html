<!DOCTYPE html>
<html>
<head>
  <title>Sagheer's Chess Board</title>
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" integrity="sha384-8Vi8XRmehGv+8ZDcQ86dvn/2scre1xOB+09iAhn121FptP4nvh1q+7h7oY8bL+w" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js" integrity="sha512-xRllwz3ikUE1vH6RceAg3l(00+w+dIOJOQ3+n9rA1s+0/0+A1s+0+A1s+0+A1s+0)" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0d1117; color: #c9d1d9; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
    #board { width: 400px; margin-bottom: 20px; }
    .btn { background-color: #238636; color: white; padding: 10px 20px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; text-decoration: none; display: inline-block; margin-top: 10px; }
    .btn:hover { background-color: #2ea043; }
    .btn:disabled { background-color: #2b3036; cursor: not-allowed; color: #6e7681; }
    h1 { margin-bottom: 20px; }
    #status { margin-bottom: 10px; font-style: italic; color: #8b949e; }
  </style>
</head>
<body>

  <h1>Sagheer's Community Chess ♟️</h1>
  <div id="status">Loading game state...</div>
  <div id="board" style="width: 400px"></div>
  <a id="moveBtn" class="btn" href="#" target="_blank" style="display: none;">Submit Move</a>

  <script>
    var board = null
    var game = new Chess()
    var $status = $('#status')
    var $moveBtn = $('#moveBtn')
    var currentFen = 'start'

    // Fetch initial state
    fetch('https://raw.githubusercontent.com/SagheerAkram/SagheerAkram/main/chess_state.json')
      .then(response => response.json())
      .then(data => {
        currentFen = data.fen
        game.load(currentFen)
        board.position(currentFen)
        updateStatus()
      })
      .catch(error => {
        console.error('Error fetching state:', error)
        $status.text('Error loading game state. Using start position.')
        game.reset()
        board.position('start')
      })

    function onDragStart (source, piece, position, orientation) {
      if (game.game_over()) return false
      // unique to Sagheer's game: only black (bot) or white (community)? 
      // Assuming Community plays White for now based on "start"
      if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
          (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
        return false
      }
    }

    function onDrop (source, target) {
      // see if the move is legal
      var move = game.move({
        from: source,
        to: target,
        promotion: 'q' // NOTE: always promote to a queen for example simplicity
      })

      // illegal move
      if (move === null) return 'snapback'

      updateStatus()
      
      // Update Button
      var moveSan = move.san // e.g. "Nf3"
      var moveUci = move.from + move.to // e.g. "g1f3"
      if (move.promotion) moveUci += move.promotion
      
      var issueTitle = "Chess Move: " + moveUci
      // Using new ISSUE_TEMPLATE/chess_move.yml if exists, or just default query params
      var issueUrl = "https://github.com/SagheerAkram/SagheerAkram/issues/new?title=" + encodeURIComponent(issueTitle) + "&body=Make move: " + moveUci
      
      $moveBtn.attr('href', issueUrl)
      $moveBtn.text('Submit Move: ' + moveSan)
      $moveBtn.show()
    }

    function onSnapEnd () {
      board.position(game.fen())
    }

    function updateStatus () {
      var status = ''
      var moveColor = 'White'
      if (game.turn() === 'b') {
        moveColor = 'Black'
      }

      if (game.in_checkmate()) {
        status = 'Game over, ' + moveColor + ' is in checkmate.'
      } else if (game.in_draw()) {
        status = 'Game over, drawn position'
      } else {
        status = moveColor + ' to move'
        if (game.in_check()) {
          status += ', ' + moveColor + ' is in check'
        }
      }

      $status.text(status)
    }

    var config = {
      draggable: true,
      position: 'start',
      onDragStart: onDragStart,
      onDrop: onDrop,
      onSnapEnd: onSnapEnd,
      pieceTheme: 'https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/img/chesspieces/wikipedia/{piece}.png'
    }
    board = Chessboard('board', config)
  </script>
</body>
</html>
